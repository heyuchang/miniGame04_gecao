{"version":3,"sources":["file:///G:/cocos/%E6%9C%AB%E6%97%A5%E7%89%B9%E5%B7%A5%E9%98%9F/assets/scripts/game/compoment/base/NoticeLayer.ts"],"names":["Component","find","instantiate","Label","NodePool","UIOpacity","UITransform","v3","_decorator","ccclass","property","NoticeLayer","contentLayer","textPool","textItem","maxContentWidth","minContentWidth","contentBGAdd","orignHeight","spaceY","status","fadeIn","delay","fadeOut","speedY","speedOpacity","delayTime","moveDy","fadeOutNode","onLoad","node","put","getComponent","height","noticeShow","content","get","active","contentNode","overflow","Overflow","NONE","string","updateRenderData","width","SHRINK","setPosition","moveY","setScale","opacity","parent","createNotice","update","dt","chs","children","backArr","i","dy","pos","getPosition","y","time","push","length","lastNode","position"],"mappings":"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","sourcesContent":["// @ts-nocheck\r\n\r\nimport { Component, find, instantiate, Label, Node, NodePool, UIOpacity, UITransform, v3, _decorator } from 'cc';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('NoticeLayer')\r\nexport class NoticeLayer extends Component {\r\n\r\n    contentLayer: Node;\r\n    textPool: NodePool;\r\n    textItem: Node;\r\n\r\n    maxContentWidth: number = 580;\r\n    minContentWidth: number = 150;\r\n    contentBGAdd: number = 150;\r\n\r\n    orignHeight: number = 0;\r\n\r\n    // 多条飘字之间的y间隔\r\n    spaceY: number = 5;\r\n\r\n    status: any = {\r\n        fadeIn: 1,\r\n        delay: 2,\r\n        fadeOut: 3\r\n    };\r\n\r\n    // 移动速度，像素/每秒\r\n    speedY: number = 300;\r\n    // 透明度变化速度，透明度/每秒\r\n    speedOpacity: number = 255 / 0.3;\r\n    // 展示不动的时间。单位：秒\r\n    delayTime: number = 0.5;\r\n    // 渐显和渐隐移动的距离\r\n    moveDy: number = 150;\r\n\r\n    // 要保证只能有一个处于fadeOut状态，其他的要处于队列等待\r\n    fadeOutNode: Node = null;\r\n\r\n    onLoad() {\r\n        this.contentLayer = find(\"contentLayer\", this.node);\r\n        this.textItem = find(\"contentLayer/textItem\", this.node);\r\n\r\n        this.textPool = new NodePool();\r\n        this.textPool.put(this.textItem);\r\n        this.textItem = instantiate(this.textItem);\r\n\r\n        this.orignHeight = find(\"content\", this.textItem).getComponent(UITransform).height;\r\n\r\n    }\r\n\r\n    noticeShow(content) {\r\n        var node = this.textPool.get();\r\n        if (!node) {\r\n            node = instantiate(this.textItem);\r\n        }\r\n        node.active = true;\r\n\r\n        let contentNode = find(\"content\", node);\r\n        contentNode.getComponent(UITransform).height = this.orignHeight;\r\n        contentNode.getComponent(Label).overflow = Label.Overflow.NONE;\r\n        contentNode.getComponent(Label).string = content + \"\";\r\n        // 调用这个方法之后，才能在本帧获得准确宽度\r\n        contentNode.getComponent(Label).updateRenderData(true);\r\n\r\n        let width = contentNode.getComponent(UITransform).width;\r\n        if (width > this.maxContentWidth) {\r\n            contentNode.getComponent(Label).overflow = Label.Overflow.SHRINK;\r\n            contentNode.getComponent(UITransform).width = this.maxContentWidth;\r\n            contentNode.getComponent(UITransform).height = this.orignHeight * 2 + 10;\r\n            width = this.maxContentWidth;\r\n        } else if (width < this.minContentWidth) {\r\n            width = this.minContentWidth;\r\n        }\r\n\r\n        // 设置背景图片宽度和高度\r\n        node.getComponent(UITransform).width = width + this.contentBGAdd;\r\n        node.getComponent(UITransform).height = contentNode.getComponent(UITransform).height + 10;\r\n\r\n        node.setPosition(0, -this.moveDy);\r\n        node.moveY = this.moveDy;\r\n        node.moveDy = 0;\r\n        node.setScale(v3(1, 1, 1));\r\n        node.getComponent(UIOpacity).opacity = 0;\r\n        node.status = this.status.fadeIn;\r\n        node.parent = this.contentLayer;\r\n\r\n    }\r\n\r\n    createNotice(content) {\r\n        this.noticeShow(content + \"\");\r\n    }\r\n\r\n    update(dt: number) {\r\n        let chs = this.contentLayer.children;\r\n        let backArr = [];\r\n        for (let i in chs) {\r\n            let node = chs[i];\r\n            switch (node.status) {\r\n                case this.status.fadeIn:\r\n                    var dy = dt * this.speedY;\r\n\r\n                    var pos = node.getPosition();\r\n                    pos.y += dy;\r\n                    node.setPosition(pos);\r\n\r\n                    node.moveDy += dy;\r\n                    var opacity = node.getComponent(UIOpacity).opacity + this.speedOpacity * dt;\r\n                    if (opacity > 255) {\r\n                        opacity = 255;\r\n                    }\r\n                    node.getComponent(UIOpacity).opacity = opacity;\r\n                    if (node.moveDy >= node.moveY) {\r\n                        node.moveDy = 0;\r\n                        node.getComponent(UIOpacity).opacity = 255;\r\n                        node.status = this.status.delay;\r\n                        node.time = 0;\r\n                        node.delayTime = this.delayTime;\r\n                    }\r\n                    break;\r\n                case this.status.delay:\r\n                    node.delayTime -= dt;\r\n                    if (node.delayTime <= 0) {\r\n                        node.delayTime = 0;\r\n                        node.status = this.status.fadeOut;\r\n                    }\r\n                    break;\r\n                case this.status.fadeOut:\r\n                    if (this.fadeOutNode && this.fadeOutNode != node) {\r\n                        break;\r\n                    }\r\n                    this.fadeOutNode = node;\r\n                    var dy = dt * this.speedY;\r\n\r\n                    var pos = node.getPosition();\r\n                    pos.y += dy;\r\n                    node.setPosition(pos);\r\n\r\n                    var opacity = node.getComponent(UIOpacity).opacity - this.speedOpacity * dt;\r\n                    if (opacity < 0) {\r\n                        opacity = 0;\r\n                    }\r\n                    node.getComponent(UIOpacity).opacity = opacity;\r\n                    if (opacity <= 0) {\r\n                        backArr.push(node);\r\n                        this.fadeOutNode = null;\r\n                    }\r\n                    break;\r\n            }\r\n        }\r\n        for (let i in backArr) {\r\n            let node = backArr[i];\r\n            node.parent = null;\r\n            this.textPool.put(node);\r\n        }\r\n\r\n        // 修正位置，保证不重叠\r\n        chs = this.contentLayer.children;\r\n        if (chs.length >= 2) {\r\n            let lastNode = chs[chs.length - 1];\r\n            for (let i = chs.length - 2; i >= 0; i--) {\r\n                let node = chs[i];\r\n\r\n                let dy = (node.getComponent(UITransform).height + lastNode.getComponent(UITransform).height) * 0.5 + this.spaceY;\r\n                if (node.position.y - lastNode.position.y < dy) {\r\n                    let pos = node.getPosition();\r\n                    pos.y = lastNode.position.y + dy;\r\n                    node.setPosition(pos);\r\n                }\r\n                lastNode = node;\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n"]}
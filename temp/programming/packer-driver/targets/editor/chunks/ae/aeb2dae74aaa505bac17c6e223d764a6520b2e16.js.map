{"version":3,"sources":["file:///G:/cocos/%E6%9C%AB%E6%97%A5%E7%89%B9%E5%B7%A5%E9%98%9F/assets/scripts/game/compoment/base/RenderChildBatch.ts"],"names":["UIRenderer","_decorator","cocosUtil","ccclass","property","RenderChildBatch","pathArr","path2RenderArr","Map","rootNodeArr","addRootItemNode","node","indexOf","pauseRender","push","rootPath","isValid","path","name","renderable","getComponent","renderArr","get","set","_realRender","_render","children","forEach","child","removeRootItemNode","removeRender","index","splice","arr","updateAssembler","batch","postUpdateAssembler","tmpArr","activeInHierarchy","_renderFlag","_assembler","onDestroy","undefined"],"mappings":"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","sourcesContent":["import { Node, UIRenderer, _decorator } from 'cc';\r\nimport { cocosUtil } from '../../../utils/cocosUtil';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('RenderChildBatch')\r\nexport class RenderChildBatch extends UIRenderer {\r\n\r\n    private pathArr: string[] = [];\r\n    private path2RenderArr: Map<string, UIRenderer[]> = new Map();\r\n\r\n    private rootNodeArr: Node[] = [];\r\n\r\n    // 添加根子节点\r\n    public addRootItemNode(node: Node) {\r\n        if (this.rootNodeArr.indexOf(node) == -1) {\r\n            this.pauseRender(node, \"\");\r\n            this.rootNodeArr.push(node);\r\n        }\r\n    }\r\n    // 架空节点提交渲染的方法\r\n    private pauseRender(node: Node, rootPath: string) {\r\n        if (!cocosUtil.isValid(node)) {\r\n            return;\r\n        }\r\n        let path = rootPath + node.name;\r\n        let renderable = node.getComponent(UIRenderer);\r\n        if (renderable) {\r\n            if (this.pathArr.indexOf(path) == -1) {\r\n                this.pathArr.push(path);\r\n            }\r\n            let renderArr = this.path2RenderArr.get(path);\r\n            if (!renderArr) {\r\n                renderArr = [];\r\n                this.path2RenderArr.set(path, renderArr);\r\n            }\r\n            if (renderArr.indexOf(renderable) == -1) {\r\n                if (!renderable._realRender) {\r\n                    renderable._realRender = renderable._render;\r\n                    renderable._render = function () { };\r\n                }\r\n                renderArr.push(renderable);\r\n            }\r\n        }\r\n\r\n        node.children.forEach((child: Node) => {\r\n            this.pauseRender(child, path + \"/\");\r\n        });\r\n    }\r\n\r\n    // 移除根子节点\r\n    public removeRootItemNode(node: Node) {\r\n        this.removeRender(node, \"\");\r\n        let index = this.rootNodeArr.indexOf(node);\r\n        if (index >= 0) {\r\n            this.rootNodeArr.splice(index, 1);\r\n        }\r\n    }\r\n    // 还原架空的方法\r\n    private removeRender(node: Node, rootPath: string) {\r\n        if (!cocosUtil.isValid(node)) {\r\n            return;\r\n        }\r\n        let path = rootPath + node.name;\r\n        let arr = this.path2RenderArr.get(path);\r\n        if (arr) {\r\n            let renderable = node.getComponent(UIRenderer);\r\n            if (renderable) {\r\n                if (renderable._realRender) {\r\n                    renderable._render = renderable._realRender;\r\n                    delete renderable._realRender;\r\n                }\r\n                let index = arr.indexOf(renderable);\r\n                if (index != -1) {\r\n                    arr.splice(index, 1);\r\n                }\r\n            }\r\n        }\r\n        node.children.forEach((child: Node) => {\r\n            this.removeRender(child, path + \"/\");\r\n        });\r\n    }\r\n\r\n    // 所有子节点渲染前调用\r\n    updateAssembler(batch: any) {\r\n\r\n    }\r\n\r\n    // 所有子节点渲染后调用\r\n    postUpdateAssembler(batch: any) {\r\n        this.pathArr.forEach((path: string) => {\r\n            let arr = this.path2RenderArr.get(path);\r\n            let tmpArr = [];\r\n            arr.forEach((renderable: UIRenderer) => {\r\n                if (!cocosUtil.isValid(renderable) || !cocosUtil.isValid(renderable.node)) {\r\n                    return;\r\n                }\r\n                tmpArr.push(renderable);\r\n                if (!renderable.node.activeInHierarchy) {\r\n                    return;\r\n                }\r\n                if (renderable._renderFlag && renderable._assembler) {\r\n                    renderable._realRender(batch);\r\n                }\r\n            });\r\n            this.path2RenderArr.set(path, tmpArr);\r\n        });\r\n    }\r\n\r\n    // 还原现场\r\n    onDestroy() {\r\n        this.pathArr.forEach((path: string) => {\r\n            let arr = this.path2RenderArr.get(path);\r\n            arr.forEach((renderable: UIRenderer) => {\r\n                if (!cocosUtil.isValid(renderable)) {\r\n                    return;\r\n                }\r\n                if (renderable._realRender) {\r\n                    renderable._render = renderable._realRender;\r\n                    delete renderable._realRender;\r\n                }\r\n            });\r\n        });\r\n        this.path2RenderArr = undefined;\r\n        this.pathArr = undefined;\r\n        this.rootNodeArr = undefined;\r\n    }\r\n\r\n}\r\n\r\n"]}
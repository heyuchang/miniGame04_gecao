{"version":3,"sources":["file:///G:/cocos/%E6%9C%AB%E6%97%A5%E7%89%B9%E5%B7%A5%E9%98%9F/assets/scripts/game/compoment/layer/PyramidDrawLayer.ts"],"names":["instantiate","Label","Node","v3","_decorator","sdkManager","tyqSDK","constants","designManager","UserData","PropItemPrefab","BaseUILayer","ccclass","property","PyramidDrawLayer","type","items","_index","_dtTime","_isStartRun","_endIndex","_drawItemArr","_isDoubleDraw","onLoad","onDisable","onDestroy","start","initItems","closeBless","closeLayer","data","getRowsByType","tableName","CNTM","index","length","push","award","propItem","itemLayer","getChildByName","addChild","position","getComponent","setView","Type_UnTouch","setScale","active","initItemState","drawItem","getInstance","$pyramidState","config","coinLabel","string","$pyramidDrawTime","update","dt","itemsIndex","getDrawIndex","curBet","Id","Num","getRewardProp","openLayer","layers","RewardLayer","propArr","setPyramidState","isHero","arr","i","startDraw","checkAndUseBaoshi","eventSendCustomEvent","Math","floor","random","toast","RewardItemLayer","propId","num","adDiamond","doubleDraw","self","openAd","st"],"mappings":"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","sourcesContent":["import { instantiate, Label, Node, Prefab, sp, Sprite, SpriteFrame, v3, _decorator } from 'cc';\r\nimport { sdkManager } from '../../../sdk/sdkManager';\r\nimport { tyqSDK } from '../../../tyqSDK/tyqSDK';\r\nimport { constants } from '../../data/constants';\r\nimport { designManager } from '../../manager/designManager';\r\nimport { PropItem, UserData } from '../../model/UserData';\r\nimport { PropItemPrefab } from '../item/PropItemPrefab';\r\nimport { BaseUILayer } from './BaseUILayer';\r\n\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('PyramidDrawLayer')\r\nexport class PyramidDrawLayer extends BaseUILayer {\r\n\r\n    @property({ type: Node }) btnClose: Node = null;\r\n\r\n    @property({ type: Node }) propItem: Node = null;\r\n\r\n    @property({ type: Node }) itemLayer: Node = null;\r\n\r\n    @property({ type: Label }) coinLabel: Label = null;\r\n\r\n\r\n    private items = []\r\n\r\n    _index = 0\r\n    _dtTime = 0\r\n    _isStartRun = false\r\n    _endIndex = 0\r\n    _drawItemArr = []\r\n\r\n    _isDoubleDraw = false\r\n\r\n    onLoad() {\r\n\r\n    }\r\n\r\n\r\n    onDisable() {\r\n        super.onDisable();\r\n    }\r\n\r\n    onDestroy() {\r\n        super.onDestroy();\r\n    }\r\n\r\n    start() {\r\n\r\n        this.initItems()\r\n    }\r\n\r\n    closeBless() {\r\n        this.closeLayer()\r\n    }\r\n\r\n    initItems() {\r\n        let data = designManager.getRowsByType(constants.tableName.CNTM, 3)\r\n        for (let index = 0; index < data.length; index++) {\r\n            this._drawItemArr.push(data[index].award)\r\n            let propItem = instantiate(this.propItem)\r\n            this.itemLayer.getChildByName(\"node\" + (index + 1)).addChild(propItem)\r\n            this.items[index] = propItem\r\n            propItem.position = v3(0, 0, 0)\r\n            propItem.getComponent(PropItemPrefab).setView(data[index].award[0][0], data[index].award[0][1], PropItemPrefab.Type_UnTouch)\r\n            propItem.getComponent(PropItemPrefab).setScale(109)\r\n            propItem.getChildByName(\"xuanzhong\").active = false\r\n        }\r\n        this.initItemState()\r\n    }\r\n\r\n    initItemState() {\r\n        for (let index = 0; index < 10 && index < this.items.length; index++) {\r\n            let drawItem = this.items[index]\r\n            drawItem.getChildByName(\"grayMask\").active = UserData.getInstance().$pyramidState[index] == 1\r\n            drawItem.getChildByName(\"xuanzhong\").active = false\r\n        }\r\n        let drawItem = designManager.config[\"jinzita\"]\r\n        this.coinLabel.string = drawItem[UserData.getInstance().$pyramidDrawTime]\r\n\r\n    }\r\n\r\n    protected update(dt: number): void {\r\n        if (!this._isStartRun) {\r\n            return\r\n        }\r\n        this._dtTime += dt\r\n        if (this._dtTime > 0.1) {\r\n            this._dtTime = 0\r\n            this._index++\r\n            for (let index = 0; index < 10; index++) {\r\n                this.items[index].getChildByName(\"xuanzhong\").active = false\r\n            }\r\n            let itemsIndex = this.getDrawIndex(this._index, this._index >= this._endIndex)\r\n            this.items[itemsIndex].getChildByName(\"xuanzhong\").active = true\r\n            if (this._index >= this._endIndex) {\r\n                this._isStartRun = false\r\n                let curBet = this._drawItemArr[itemsIndex][0]\r\n                let propItem: PropItem = {\r\n                    Id: curBet[0],\r\n                    Num: this._isDoubleDraw ? curBet[1] * 2 : curBet[1]\r\n                };\r\n                UserData.getInstance().getRewardProp([propItem])\r\n                this.openLayer(constants.layers.RewardLayer, { propArr: [propItem] });\r\n\r\n                UserData.getInstance().setPyramidState(itemsIndex)\r\n                UserData.getInstance().$pyramidDrawTime++\r\n                if (UserData.getInstance().$pyramidDrawTime >= 10) {\r\n                    UserData.getInstance().$pyramidDrawTime = 0\r\n                    UserData.getInstance().$pyramidState = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0]\r\n                }\r\n\r\n                this.initItemState()\r\n            }\r\n        }\r\n    }\r\n\r\n    getDrawIndex(index, isHero) {\r\n        if (UserData.getInstance().$pyramidDrawTime == 9) {\r\n            return 0\r\n        }\r\n        let arr = []\r\n        for (let i = isHero ? 1 : 0; i < UserData.getInstance().$pyramidState.length; i++) {\r\n            if (UserData.getInstance().$pyramidState[i] == 0) {\r\n                arr.push(i)\r\n            }\r\n        }\r\n        return arr[index % arr.length]\r\n    }\r\n\r\n    startDraw() {\r\n        if (this._isStartRun) {\r\n            return\r\n        }\r\n        let drawItem = designManager.config[\"jinzita\"]\r\n        if (UserData.getInstance().checkAndUseBaoshi(drawItem[UserData.getInstance().$pyramidDrawTime])) {\r\n            tyqSDK.eventSendCustomEvent(\"庆典消耗钻石——\"+drawItem[UserData.getInstance().$pyramidDrawTime])\r\n            this._isStartRun = true\r\n            this._isDoubleDraw = false\r\n            if (UserData.getInstance().$pyramidDrawTime == 9) {\r\n                this._endIndex = 10\r\n            } else {\r\n                this._endIndex = Math.floor(Math.random() * 10) + 20 - UserData.getInstance().$pyramidDrawTime\r\n            }\r\n            this._index = 0\r\n        }\r\n        else {\r\n            this.toast(\"钻石不足\")\r\n            this.openLayer(constants.layers.RewardItemLayer, { propId: 801, num: designManager.config.adDiamond })\r\n        }\r\n    }\r\n\r\n    doubleDraw() {\r\n        let self = this\r\n        sdkManager.openAd(\"参与庆典\", function (st) {\r\n            if (st == 1) {\r\n                if (self._isStartRun) {\r\n                    return\r\n                }\r\n                self._isStartRun = true\r\n                if (UserData.getInstance().$pyramidDrawTime == 9) {\r\n                    self._endIndex = 10\r\n                } else {\r\n                    self._endIndex = Math.floor(Math.random() * 10) + 20 - UserData.getInstance().$pyramidDrawTime\r\n                }\r\n                self._index = 0\r\n              //  self._isDoubleDraw = true\r\n            }\r\n        })\r\n    }\r\n}\r\n\r\n"]}
{"version":3,"sources":["file:///G:/cocos/%E6%9C%AB%E6%97%A5%E7%89%B9%E5%B7%A5%E9%98%9F/assets/scripts/game/compoment/layer/LoadingLayer.ts"],"names":["ProgressBar","Sprite","_decorator","WECHAT","sdkManager","GLoginState","CronCtr","ServerCtr","ChannelFlag","tyqSDK","constants","designManager","layerManager","resManager","playerModel","BaseLayer","ccclass","property","LoadingLayer","progressBar","progress","percentNode","flagNode","progressLength","startGap","designResProgress","designResPercent","bundleArrProgress","bundleArrPercent","bundleLoadingTime","bundleLoadingMaxTime","layerProgress","layerPercent","spriteFrameArr","isLogined","onLoad","getNodeByPath","setString","getComponent","setProgressBar","pos","getPosition","x","setPosition","screenAdapterBG","collectAllSpriteFrame","node","initGame","initSDK","channel","WECHAT_JJWS","gameName","chs","children","active","getInstance","init","GetInstance","loginState","loginWithoutAccount","onClickLoginBtn","onEnable","loadDesignRes","bundleArr","bundles","common","hint","icon","layer","monster","prefab","spine","ui","bullet","wwqVec","loadBundleArr","percent","loadCommonLayerRes","eventSendCustomEvent","onDisable","onDestroy","releaseAllSpriteFrame","sp","spriteFrame","push","i","length","ch","decRef","cb","loadAllDesignTable","loadCommonLayers","openHomeLayer","closeLayer","openLayer","layers","HomeLayer","onButtonClick","name","update","dt","p","Math","ceil","noYet","undefined"],"mappings":"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","sourcesContent":["import { Node, ProgressBar, Sprite, SpriteFrame, _decorator } from 'cc';\r\nimport { WECHAT } from 'cc/env';\r\nimport { sdkManager } from '../../../sdk/sdkManager';\r\nimport { GLoginState } from '../../../tyqSDK/network/conf';\r\nimport CronCtr from '../../../tyqSDK/network/CronCtr';\r\nimport ServerCtr from '../../../tyqSDK/network/ServerCtr';\r\nimport { ChannelFlag, tyqSDK } from '../../../tyqSDK/tyqSDK';\r\nimport { constants } from '../../data/constants';\r\nimport { designManager } from '../../manager/designManager';\r\nimport { layerManager } from '../../manager/layerManager';\r\nimport { resManager } from '../../manager/resManager';\r\nimport { playerModel } from '../../model/playerModel';\r\nimport { BaseLayer } from '../base/BaseLayer';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('LoadingLayer')\r\nexport class LoadingLayer extends BaseLayer {\r\n\r\n    progressBar: ProgressBar;\r\n    progress: number = 0;\r\n    percentNode: Node;\r\n\r\n    flagNode: Node;\r\n    progressLength: number = 428;\r\n    startGap: number = -202;\r\n\r\n    designResProgress: number = 0;\r\n    designResPercent: number = 0.1;\r\n\r\n    bundleArrProgress: number = 0;\r\n    bundleArrPercent: number = 0.8;\r\n    // 由于bundle加载，没有过程回调，因此模拟一个加载过程，创造友好体验\r\n    bundleLoadingTime: number = -1;\r\n    bundleLoadingMaxTime: number = 6;\r\n\r\n    layerProgress: number = 0;\r\n    layerPercent: number = 0.1;\r\n\r\n    spriteFrameArr: SpriteFrame[] = [];\r\n\r\n    isLogined: boolean = false\r\n\r\n    onLoad() {\r\n\r\n        super.onLoad();\r\n\r\n        this.percentNode = this.getNodeByPath(\"ui/progressBar/percent\");\r\n        this.setString(this.percentNode, \"0%\");\r\n\r\n        this.progressBar = this.getNodeByPath(\"ui/progressBar\").getComponent(ProgressBar);\r\n        this.setProgressBar(this.progressBar, this.progress);\r\n\r\n        this.flagNode = this.getNodeByPath(\"ui/progressBar/flag\");\r\n        let pos = this.flagNode.getPosition();\r\n        pos.x = this.startGap;\r\n        this.flagNode.setPosition(pos);\r\n        this.screenAdapterBG(this.getNodeByPath(\"bg\"))\r\n        this.collectAllSpriteFrame(this.node);\r\n        tyqSDK.initGame()\r\n        sdkManager.initSDK()\r\n        if (tyqSDK.channel == ChannelFlag.WECHAT_JJWS) {\r\n            constants.gameName = \"jjws\";\r\n        }\r\n\r\n        // 游戏名字处理\r\n        let chs = this.getNodeByPath(\"ui/logo\").children;\r\n        for (let node of chs) {\r\n            node.active = false;\r\n        }\r\n        // switch (tyqSDK.channel) {\r\n        //     case ChannelFlag.WECHAT_JJWS:\r\n        //         this.getNodeByPath(\"ui/logo/jjws\").active = true;\r\n        //         break;\r\n        //     default:\r\n        //         this.getNodeByPath(\"ui/logo/mrtgd\").active = true;\r\n        //         break;\r\n        // }\r\n\r\n        //使用本地登录微信账号\r\n      //  let accountNode = this.getNodeByPath(\"account\")\r\n       // accountNode.active = false\r\n        // if(playerModel.isInDevelopmentEnvironment() && HTML5){\r\n        //     accountNode.active = HTML5\r\n        // }\r\n\r\n        //微信登录\r\n        if (WECHAT) {\r\n            CronCtr.getInstance().init() //开启心跳\r\n        } else {\r\n            ServerCtr.GetInstance().loginState = GLoginState.loginWithoutAccount\r\n        }\r\n    }\r\n\r\n    onClickLoginBtn() {\r\n        // let account = this.getNodeByPath(\"account/AccountLabel\").getComponent(Label)!\r\n        // ServerCtr.GetInstance().reqLoginByAccount(account.string, \"\")\r\n    }\r\n\r\n    onEnable() {\r\n        super.onEnable();\r\n\r\n        this.loadDesignRes(() => {\r\n            // 加载bundle\r\n            this.bundleLoadingTime = 0;\r\n            let bundleArr = [\r\n                constants.bundles.common,\r\n                constants.bundles.hint,\r\n                constants.bundles.icon,\r\n                constants.bundles.layer,\r\n                constants.bundles.monster,\r\n                constants.bundles.prefab,\r\n                constants.bundles.spine,\r\n                constants.bundles.ui,\r\n                constants.bundles.bullet,\r\n                constants.bundles.wwqVec,\r\n\r\n            ];\r\n            resManager.loadBundleArr(bundleArr, (percent: number) => {\r\n                this.bundleArrProgress = percent;\r\n            }, () => {\r\n                this.bundleArrProgress = 1;\r\n                // 再去加载其他需要的资源\r\n                this.loadCommonLayerRes();\r\n            });\r\n        });\r\n        tyqSDK.eventSendCustomEvent(\"进入加载页\", \"玩家人数\")\r\n    }\r\n\r\n    onDisable() {\r\n        super.onDisable();\r\n    }\r\n\r\n    onDestroy() {\r\n        super.onDestroy();\r\n\r\n        this.releaseAllSpriteFrame();\r\n    }\r\n\r\n    collectAllSpriteFrame(node: Node) {\r\n        let sp: Sprite = node.getComponent(Sprite);\r\n        if (sp && sp.spriteFrame) {\r\n            this.spriteFrameArr.push(sp.spriteFrame);\r\n        }\r\n        let chs = node.children;\r\n        for (let i = 0; i < chs.length; i++) {\r\n            let ch = chs[i];\r\n            this.collectAllSpriteFrame(ch);\r\n        }\r\n    }\r\n\r\n    releaseAllSpriteFrame() {\r\n        for (let i = 0; i < this.spriteFrameArr.length; i++) {\r\n            let spriteFrame: SpriteFrame = this.spriteFrameArr[i];\r\n            spriteFrame.decRef();\r\n        }\r\n        this.spriteFrameArr = [];\r\n    }\r\n\r\n    loadDesignRes(cb?: Function) {\r\n        // 加载策划表格数据\r\n        designManager.loadAllDesignTable((percent: number) => {\r\n            this.designResProgress = percent;\r\n        }, () => {\r\n            this.designResProgress = 1;\r\n            if (cb) {\r\n                cb();\r\n            }\r\n        });\r\n    }\r\n\r\n    loadCommonLayerRes() {\r\n        // 加载layer资源\r\n        layerManager.loadCommonLayers((percent: number) => {\r\n            this.layerProgress = percent;\r\n        }, () => {\r\n            this.layerProgress = 1;\r\n        });\r\n    }\r\n\r\n    openHomeLayer() {\r\n        this.closeLayer();\r\n        this.openLayer(constants.layers.HomeLayer);\r\n        tyqSDK.eventSendCustomEvent(\"进入游戏主界面\", \"玩家人数\")\r\n    }\r\n\r\n    onButtonClick(node: Node, name: String) {\r\n        switch (name) {\r\n            default:\r\n                break;\r\n        }\r\n    }\r\n\r\n    update(dt: number) {\r\n        if (!this.progressBar) {\r\n            return;\r\n        }\r\n        if (this.bundleLoadingTime >= 0) {\r\n            this.bundleLoadingTime += dt;\r\n            let p = this.bundleLoadingTime / this.bundleLoadingMaxTime;\r\n            if (p > 1) {\r\n                p = 1;\r\n            }\r\n            if (p > this.bundleArrProgress) {\r\n                this.bundleArrProgress = p;\r\n            }\r\n            if (this.bundleArrProgress >= 1) {\r\n                // 去除小数\r\n                this.bundleArrProgress = 1;\r\n            }\r\n        }\r\n\r\n        let progress = this.designResProgress * this.designResPercent\r\n            + this.bundleArrProgress * this.bundleArrPercent\r\n            + this.layerProgress * this.layerPercent;\r\n\r\n        // 防止计算过后，是0.999999的情况    \r\n        progress = Math.ceil(progress * 10000) / 10000;\r\n\r\n        if (progress > this.progressBar.progress) {\r\n            this.setProgressBar(this.progressBar, progress);\r\n            this.setString(this.percentNode, Math.ceil(progress * 100) + \"%\");\r\n\r\n            let pos = this.flagNode.getPosition();\r\n            pos.x = progress * this.progressLength + this.startGap;\r\n            this.flagNode.setPosition(pos);\r\n        }\r\n        if (progress >= 1) {\r\n            // myLog.i(\"load end:\" + ServerCtr.GetInstance().loginState);\r\n            if (ServerCtr.GetInstance().loginState == GLoginState.noYet) {\r\n                return;\r\n            }\r\n            // if (ServerCtr.GetInstance().loginState == GLoginState.loginFail) {\r\n            //     this.showHintLayer(\"登陆失败，请保证网络畅通后，重启游戏\", () => {\r\n            //         game.restart();\r\n            //     });\r\n            //     return;\r\n            // }\r\n            this.progressBar = undefined;\r\n            playerModel.init();\r\n            this.openHomeLayer();\r\n        }\r\n    }\r\n\r\n}\r\n\r\n"]}
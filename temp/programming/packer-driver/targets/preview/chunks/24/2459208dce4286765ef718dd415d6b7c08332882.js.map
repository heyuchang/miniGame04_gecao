{"version":3,"sources":["file:///G:/cocos/%E6%9C%AB%E6%97%A5%E7%89%B9%E5%B7%A5%E9%98%9F/assets/scripts/game/compoment/shader/ShineColor.ts"],"names":["Component","Material","sp","UIRenderer","v4","_decorator","constants","resManager","ccclass","property","ShineColor","duration","_median","_time","isSpine","uiRenderer","orignMaterial","vColor","onLoad","node","getComponent","customMaterial","Skeleton","setMaterialProperty","val","cache","_materialCache","i","material","setProperty","getMaterialInstance","uRate","passes","getHandle","setUniform","uColor","setMaterialInstance","update","dt","rate","Math","abs","removeShineColorMaterial","enabled","startShine","materialPath","color","r","g","b","a","loadAsset","bundles","common","err"],"mappings":"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","sourcesContent":["import { Color, Component, Material, sp, UIRenderer, v4, Vec4, _decorator } from 'cc';\r\nimport { constants } from '../../data/constants';\r\nimport { resManager } from '../../manager/resManager';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('ShineColor')\r\nexport class ShineColor extends Component {\r\n    duration: number = 0.3;\r\n    _median: number = 0;\r\n    _time: number = 0;\r\n\r\n    isSpine: boolean = false;\r\n\r\n    uiRenderer: UIRenderer;\r\n    orignMaterial: Material;\r\n    vColor: Vec4;\r\n\r\n    onLoad() {\r\n        this.uiRenderer = this.node.getComponent(UIRenderer);\r\n        this.orignMaterial = this.uiRenderer.customMaterial;\r\n\r\n        if (this.node.getComponent(sp.Skeleton)) {\r\n            this.isSpine = true;\r\n        }\r\n    }\r\n\r\n    setMaterialProperty(val: number) {\r\n        if (this.isSpine) {\r\n            // @ts-ignore \r\n            let cache: any = this.uiRenderer._materialCache;\r\n            for (let i in cache) {\r\n                let material = cache[i];\r\n                material.setProperty(\"u_rate\", val);\r\n                if (this.vColor) {\r\n                    material.setProperty(\"u_color\", this.vColor);\r\n                }\r\n            }\r\n            return;\r\n        }\r\n\r\n        let material = this.uiRenderer.getMaterialInstance(0);\r\n        let uRate = material.passes[0].getHandle(\"u_rate\");\r\n        material.passes[0].setUniform(uRate, val);\r\n        if (this.vColor) {\r\n            let vColor = v4(1, 0, 0, 1);\r\n            let uColor = material.passes[0].getHandle(\"u_color\");\r\n            material.passes[0].setUniform(uColor, this.vColor);\r\n        }\r\n        this.uiRenderer.setMaterialInstance(material, 0);\r\n\r\n    }\r\n\r\n    update(dt: number) {\r\n        if (this._time > 0) {\r\n            this._time -= dt;\r\n            this._time = this._time < 0 ? 0 : this._time;\r\n            let rate = Math.abs(this._time - this._median) * 2 / this.duration;\r\n            this.setMaterialProperty(rate);\r\n        } else {\r\n            this.removeShineColorMaterial();\r\n        }\r\n    }\r\n\r\n    removeShineColorMaterial() {\r\n        this.uiRenderer.customMaterial = this.orignMaterial;\r\n        if (this.isSpine) {\r\n            // spine动画，需要重新激活，否则替换材质后会不显示\r\n            this.uiRenderer.enabled = false;\r\n            this.uiRenderer.enabled = true;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 闪颜色\r\n     * @param materialPath 材质路径 \r\n     * @param color 闪的颜色\r\n     * @param duration 闪的时间\r\n     */\r\n    startShine(materialPath: string, color?: Color, duration: number = 0.3) {\r\n        this.duration = duration;\r\n        this._median = this.duration / 2;\r\n\r\n        if (color) {\r\n            this.vColor = v4(color.r / 255, color.g / 255, color.b / 255, color.a / 255);\r\n        } else {\r\n            // 默认闪白\r\n            this.vColor = v4(1, 1, 1, 1);\r\n        }\r\n        resManager.loadAsset(constants.bundles.common, materialPath, Material, null, (err, material) => {\r\n            this._time = this.duration;\r\n            this.uiRenderer.customMaterial = material;\r\n            this.setMaterialProperty(1);\r\n        });\r\n    }\r\n}\r\n"]}
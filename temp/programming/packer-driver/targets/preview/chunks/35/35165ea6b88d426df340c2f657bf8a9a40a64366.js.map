{"version":3,"sources":["file:///G:/cocos/%E6%9C%AB%E6%97%A5%E7%89%B9%E5%B7%A5%E9%98%9F/assets/scripts/game/compoment/base/ItemLayer.ts"],"names":["Component","instantiate","sys","_decorator","RenderChildBatch","ccclass","property","ItemLayer","itemUI","itemUIFreeArr","itemUIArr","idItemUIObj","layerJS","callback","renderChildBatch","isFrameLoad","dataArr","onLoad","node","children","active","hideAllItems","addRenderChildBatch","isNative","getComponent","addComponent","chs","push","initUI","arr","i","item","addItem","frameAddItem","setFrameLoad","frameLoad","scheduleOnce","length","shift","cb","parent","index","id","undefined","addButtonListener","addRootItemNode","getItemUIById","getItemUIByIndex","forShowItemUI","loadAndRefreshItemUIByItem","refreshItemUIByItem","refreshItemUIByItemUI","refreshItemUIById","removeItemUIByIndex","tmpItemUI","removeItemUIByItemUI","removeItemUIById","indexOf","splice","removeRootItemNode","ret","refreshUI"],"mappings":"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","sourcesContent":["import { Component, instantiate, Node, sys, _decorator } from 'cc';\r\nimport { BaseLayer } from './BaseLayer';\r\nimport { RenderChildBatch } from './RenderChildBatch';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('ItemLayer')\r\nexport class ItemLayer extends Component {\r\n\r\n    private itemUI: Node;\r\n\r\n    // 缓存还未被使用的itemUI\r\n    private itemUIFreeArr: any;\r\n    // 正在显示的itemUI数组\r\n    private itemUIArr: any;\r\n\r\n    private idItemUIObj: any = {};\r\n\r\n    private layerJS: BaseLayer;\r\n    private callback: Function;\r\n\r\n    public renderChildBatch: RenderChildBatch = null;\r\n\r\n    private isFrameLoad: boolean = false;\r\n    private dataArr: any[] = [];\r\n\r\n    onLoad() {\r\n        this.itemUI = this.node.children[0];\r\n        this.itemUI.active = false;\r\n\r\n        this.hideAllItems();\r\n\r\n        this.addRenderChildBatch();\r\n    }\r\n\r\n    public addRenderChildBatch() {\r\n        if (sys.isNative) {\r\n            return;\r\n        }\r\n        this.renderChildBatch = this.getComponent(RenderChildBatch);\r\n        if (this.renderChildBatch) {\r\n            return;\r\n        }\r\n        this.renderChildBatch = this.addComponent(RenderChildBatch);\r\n    }\r\n\r\n    hideAllItems() {\r\n        let chs = this.node.children;\r\n        this.itemUIFreeArr = [];\r\n        this.itemUIArr = [];\r\n        this.idItemUIObj = {};\r\n\r\n        for (let node of chs) {\r\n            node.active = false;\r\n            this.itemUIFreeArr.push(node);\r\n        }\r\n    }\r\n\r\n    initUI(layerJS: BaseLayer, arr: any, callback: Function) {\r\n        this.layerJS = layerJS;\r\n        this.callback = callback;\r\n\r\n        // 先全部回收隐藏\r\n        this.hideAllItems();\r\n\r\n        this.itemUIArr = [];\r\n        this.idItemUIObj = {};\r\n\r\n        if (!this.isFrameLoad) {\r\n            for (let i in arr) {\r\n                let item = arr[i];\r\n                this.addItem(item);\r\n            }\r\n            return;\r\n        }\r\n\r\n        this.dataArr = arr;\r\n        this.frameAddItem();\r\n    }\r\n\r\n    setFrameLoad(frameLoad: boolean) {\r\n        this.isFrameLoad = frameLoad;\r\n    }\r\n\r\n    frameAddItem() {\r\n        this.scheduleOnce(() => {\r\n            if (!this.dataArr || this.dataArr.length <= 0) {\r\n                return;\r\n            }\r\n            let item = this.dataArr.shift();\r\n            this.addItem(item);\r\n            this.frameAddItem();\r\n        });\r\n    }\r\n\r\n    addItem(item: any, cb?: Function) {\r\n        let itemUI = this.itemUIFreeArr.shift();\r\n        if (!itemUI) {\r\n            itemUI = instantiate(this.itemUI);\r\n            itemUI.parent = this.node;\r\n        }\r\n        itemUI.active = true;\r\n        itemUI.item = item;\r\n        let index = this.itemUIArr.length;\r\n        itemUI.index = index;\r\n\r\n        if (typeof (item) == \"object\" && item && item.id != undefined) {\r\n            this.idItemUIObj[item.id] = itemUI;\r\n        }\r\n\r\n        if (cb) {\r\n            cb(itemUI, item, index);\r\n        } else if (this.callback) {\r\n            this.callback(itemUI, item, index);\r\n        }\r\n\r\n        if (this.layerJS && this.layerJS.addButtonListener) {\r\n            this.layerJS.addButtonListener(itemUI);\r\n        }\r\n\r\n        this.itemUIArr.push(itemUI);\r\n\r\n        if (this.renderChildBatch) {\r\n            this.renderChildBatch.addRootItemNode(itemUI);\r\n        }\r\n\r\n        return itemUI;\r\n    }\r\n\r\n    getItemUIById(id: number) {\r\n        if (id == undefined) {\r\n            return null;\r\n        }\r\n        let itemUI = this.idItemUIObj[id];\r\n\r\n        return itemUI;\r\n    }\r\n\r\n    getItemUIByIndex(index: number) {\r\n        let itemUI = null;\r\n        this.forShowItemUI((node: Node, item: any) => {\r\n            if (node[\"index\"] == index) {\r\n                itemUI = node;\r\n                return true;\r\n            }\r\n        });\r\n\r\n        return itemUI;\r\n    }\r\n\r\n    loadAndRefreshItemUIByItem(item: any, cb?: Function) {\r\n        if (!item || item.id == undefined) {\r\n            return;\r\n        }\r\n        let itemUI = this.getItemUIById(item.id);\r\n        if (!itemUI) {\r\n            this.addItem(item, cb);\r\n            return;\r\n        }\r\n        this.refreshItemUIByItem(item);\r\n    }\r\n\r\n    refreshItemUIByItem(item: any) {\r\n        if (!item || item.id == undefined) {\r\n            return;\r\n        }\r\n        let itemUI = this.getItemUIById(item.id);\r\n        if (!itemUI) {\r\n            return;\r\n        }\r\n\r\n        itemUI.item = item;\r\n        this.refreshItemUIByItemUI(itemUI);\r\n    }\r\n\r\n    refreshItemUIByItemUI(itemUI: Node) {\r\n        let item = itemUI[\"item\"];\r\n        if (this.callback) {\r\n            this.callback(itemUI, item, itemUI[\"index\"]);\r\n        }\r\n    }\r\n\r\n    refreshItemUIById(id: number) {\r\n        let itemUI = this.getItemUIById(id);\r\n        if (!itemUI) {\r\n            return;\r\n        }\r\n        this.refreshItemUIByItem(itemUI.item);\r\n    }\r\n\r\n    removeItemUIByIndex(index: number) {\r\n        if (index < 0 || index >= this.itemUIArr.length) {\r\n            return;\r\n        }\r\n        let itemUI = null;\r\n        for (let i = 0; i < this.itemUIArr.length; i++) {\r\n            let tmpItemUI = this.itemUIArr[i];\r\n            if (!tmpItemUI.active || tmpItemUI[\"index\"] != index) {\r\n                continue;\r\n            }\r\n            itemUI = tmpItemUI;\r\n            break;\r\n        }\r\n        this.removeItemUIByItemUI(itemUI);\r\n    }\r\n\r\n    removeItemUIById(id: number) {\r\n        if (id == undefined) {\r\n            return;\r\n        }\r\n        let itemUI = this.idItemUIObj[id];\r\n        this.removeItemUIByItemUI(itemUI);\r\n    }\r\n\r\n    removeItemUIByItemUI(itemUI: Node) {\r\n        if (!itemUI) {\r\n            return;\r\n        }\r\n        itemUI.active = false;\r\n        if (this.itemUIFreeArr.indexOf(itemUI) == -1) {\r\n            // 返回缓存池\r\n            itemUI[\"index\"] = -1;\r\n            this.itemUIFreeArr.push(itemUI);\r\n        }\r\n\r\n        let item = itemUI[\"item\"];\r\n        let index = this.itemUIArr.indexOf(itemUI);\r\n        if (index != -1) {\r\n            // 从正在显示的数组中移除\r\n            this.itemUIArr.splice(index, 1);\r\n            // 重新计算索引index\r\n            for (let i = index; i < this.itemUIArr.length; i++) {\r\n                this.itemUIArr[i][\"index\"] = i;\r\n            }\r\n        }\r\n\r\n        if (typeof (item) == \"object\" && item && item.id != undefined) {\r\n            delete this.idItemUIObj[item.id];\r\n        }\r\n\r\n        if (this.renderChildBatch) {\r\n            this.renderChildBatch.removeRootItemNode(itemUI);\r\n        }\r\n    }\r\n\r\n    forShowItemUI(cb: Function) {\r\n        if (!cb) {\r\n            return;\r\n        }\r\n        for (let itemUI of this.itemUIArr) {\r\n            let ret = cb(itemUI, itemUI.item);\r\n            if (ret) {\r\n                break;\r\n            }\r\n        }\r\n    }\r\n\r\n    refreshUI() {\r\n        if (!this.callback) {\r\n            return;\r\n        }\r\n        for (let node of this.itemUIArr) {\r\n            this.callback(node, node[\"item\"], node[\"index\"]);\r\n        }\r\n    }\r\n}\r\n\r\n"]}
{"version":3,"sources":["file:///G:/cocos/%E6%9C%AB%E6%97%A5%E7%89%B9%E5%B7%A5%E9%98%9F/assets/scripts/game/compoment/item/bullet/Bullet.ts"],"names":["BoxCollider2D","Component","Contact2DType","find","Tween","v3","Vec2","Vec3","_decorator","cocosUtil","utilTools","constants","audioManager","designManager","mapModel","physicsGroup","Monster","ccclass","property","Bullet","id","row","direction","isDestroyInNoShow","extraObj","speed","atk","bodyNode","collider","bulletUtil","timeCount","contactItemArr","isFollow","rotateSpeed","Math","PI","vec3Obj","targetPos","outVec3","onLoad","node","getComponent","on","BEGIN_CONTACT","contactBegin","END_CONTACT","contactEnd","onDestroy","init","group","startWorldPos","enabled","convertToWorldSpace","player","pos","convertToNodeSpace","setPosition","getFacePlayerDirection","x","y","clone","normalize","getRowById","tableName","bullet","angle","radianToAngle","atan2","stopAllByTarget","unscheduleAllCallbacks","bulletUtilStr","name","addComponentOnce","e","getPosition","subtract","setDirection","selfCollider","otherCollider","contactItem","MONSTER","tag","PLAYER","contactEnmeyCanHide","recycleSelf","indexOf","push","contactBulletTime","dam","atkPercentAdd","ceil","hitWithDam","getShineColor","playEffect","audio","MONSTER_BULLET","index","splice","shineColor","contactNotHide","outScreenCanRecyle","outScreenNotRecycle","bulletSystem","recycleBulletNode","recycleSelfEnd","getFollowTargetPos","vec3CopyVal","position","update","dt","canMove","moveStop","dis","radian1","radian2","dr","maxDr","abs","rotateZ","ZERO","lastDirection","arriveTargetPos","add","multiplyScalar","afterDirection","afterAngle","length","forArr","timeGap","isInScreenVisible"],"mappings":"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","sourcesContent":["import { BoxCollider2D, Collider2D, Component, Contact2DType, find, Node, Tween, v3, Vec2, Vec3, _decorator } from 'cc';\r\nimport { cocosUtil } from '../../../../utils/cocosUtil';\r\nimport { utilTools } from '../../../../utils/utilTools';\r\nimport { constants } from '../../../data/constants';\r\nimport { audioManager } from '../../../manager/audioManager';\r\nimport { designManager } from '../../../manager/designManager';\r\nimport { mapModel } from '../../../model/mapModel';\r\nimport { physicsGroup } from '../../../other/physicsGroup';\r\nimport { Monster } from '../monsters/Monster';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('Bullet')\r\nexport class Bullet extends Component {\r\n\r\n    id: number;\r\n    row: any;\r\n    direction: Vec3;\r\n    isDestroyInNoShow: boolean;\r\n    extraObj: any;\r\n\r\n    speed: number;\r\n    atk: number;\r\n\r\n    bodyNode: Node;\r\n    collider: BoxCollider2D;\r\n    bulletUtil: any;\r\n\r\n    timeCount: number;\r\n\r\n    contactItemArr: any;\r\n\r\n    // 是否是跟踪子弹，默认是跟踪玩家\r\n    isFollow: boolean = false;\r\n    // 跟踪转速\r\n    rotateSpeed: number = Math.PI / 3;\r\n\r\n    // Vec3集中缓存\r\n    vec3Obj = {\r\n        targetPos: v3(0, 0, 0),\r\n        direction: v3(0, 0, 0),\r\n\r\n        outVec3: v3(0, 0, 0),\r\n    };\r\n\r\n    onLoad() {\r\n        this.collider = this.node.getComponent(BoxCollider2D);\r\n        if (this.collider) {\r\n            this.collider.on(Contact2DType.BEGIN_CONTACT, this.contactBegin, this);\r\n            this.collider.on(Contact2DType.END_CONTACT, this.contactEnd, this);\r\n        }\r\n        this.bodyNode = find(\"body\", this.node);\r\n    }\r\n\r\n    onDestroy() {\r\n\r\n    }\r\n\r\n    init(id: number, group: number, startWorldPos?: Vec3, direction?: Vec3, extraObj?: any) {\r\n        if (!this.bodyNode) {\r\n            this.onLoad();\r\n        }\r\n\r\n        if (this.collider) {\r\n            this.collider.group = group;\r\n            this.collider.enabled = true;\r\n        }\r\n        this.id = id;\r\n        this.extraObj = extraObj;\r\n\r\n        if (!startWorldPos) {\r\n            // 默认起始位置为玩家位置\r\n            startWorldPos = cocosUtil.convertToWorldSpace(mapModel.player.node);\r\n        }\r\n        let pos = cocosUtil.convertToNodeSpace(this.node, startWorldPos);\r\n        this.node.setPosition(pos);\r\n\r\n        if (!direction) {\r\n            // 默认朝向玩家\r\n            direction = this.getFacePlayerDirection();\r\n        }\r\n        if (direction.x == 0 && direction.y == 0) {\r\n            direction.x = 1;\r\n        }\r\n        this.direction = direction.clone().normalize();\r\n\r\n        let row = designManager.getRowById(constants.tableName.bullet, id);\r\n        this.row = row;\r\n        this.speed = row.speed;\r\n        this.atk = row.atk;\r\n\r\n        let angle = utilTools.radianToAngle(Math.atan2(this.direction.y, this.direction.x));\r\n        this.node.angle = angle;\r\n\r\n        this.timeCount = 0;\r\n        this.isFollow = false;\r\n        this.contactItemArr = [];\r\n        this.isDestroyInNoShow = false;\r\n        Tween.stopAllByTarget(this.node);\r\n        this.unscheduleAllCallbacks();\r\n\r\n        try {\r\n            let bulletUtilStr = this.node.name;\r\n            switch (this.node.name) {\r\n                case \"bullet1011\":\r\n                case \"bullet1012\":\r\n                    bulletUtilStr = \"bullet1011\";\r\n                    break;\r\n                case \"bullet1021\":\r\n                case \"bullet1022\":\r\n                    bulletUtilStr = \"bullet1021\";\r\n                    break;\r\n                case \"bullet1041\":\r\n                case \"bullet1043\":\r\n                    bulletUtilStr = \"bullet1041\";\r\n                    break;\r\n                case \"bullet1042\":\r\n                case \"bullet1044\":\r\n                    bulletUtilStr = \"bullet1042\";\r\n                    break;\r\n                case \"bullet1051\":\r\n                case \"bullet1053\":\r\n                    bulletUtilStr = \"bullet1051\";\r\n                    break;\r\n                case \"bullet1052\":\r\n                case \"bullet1054\":\r\n                    bulletUtilStr = \"bullet1052\";\r\n                    break;\r\n                case \"bullet1061\":\r\n                case \"bullet1062\":\r\n                    bulletUtilStr = \"bullet1061\";\r\n                    break;\r\n                case \"bullet1081\":\r\n                case \"bullet1082\":\r\n                    bulletUtilStr = \"bullet1081\";\r\n                    break;\r\n                case \"bullet1091\":\r\n                case \"bullet1092\":\r\n                    bulletUtilStr = \"bullet1091\";\r\n                    break;\r\n                case \"bullet1101\":\r\n                case \"bullet1104\":\r\n                    bulletUtilStr = \"bullet1101\";\r\n                    break;\r\n                case \"bullet1102\":\r\n                case \"bullet1105\":\r\n                    bulletUtilStr = \"bullet1102\";\r\n                    break;\r\n                case \"bullet1103\":\r\n                case \"bullet1106\":\r\n                    bulletUtilStr = \"bullet1103\";\r\n                    break;\r\n                default:\r\n                    break;\r\n            }\r\n            let bulletUtil = cocosUtil.addComponentOnce(this, bulletUtilStr);\r\n            bulletUtil.unscheduleAllCallbacks();\r\n            this.bulletUtil = bulletUtil;\r\n            // @ts-ignore\r\n            bulletUtil.init(this);\r\n        } catch (e) {\r\n\r\n        }\r\n\r\n    }\r\n\r\n    getFacePlayerDirection() {\r\n        let pos = this.node.getPosition();\r\n        return mapModel.player.node.getPosition().subtract(pos);\r\n    }\r\n\r\n    setDirection(direction: Vec3) {\r\n        this.direction = direction.normalize();\r\n    }\r\n\r\n    contactBegin(selfCollider: Collider2D, otherCollider: Collider2D) {\r\n        let contactItem = null;\r\n        if (otherCollider.group == physicsGroup.MONSTER && otherCollider.tag == 0) {\r\n            contactItem = otherCollider.getComponent(Monster);\r\n        } else if (otherCollider.group == physicsGroup.PLAYER) {\r\n            contactItem = mapModel.player;\r\n        }\r\n        if (contactItem) {\r\n            // 子弹打到敌方\r\n            if (this.contactEnmeyCanHide()) {\r\n                this.recycleSelf();\r\n            } else {\r\n                if (this.contactItemArr.indexOf(contactItem) == -1) {\r\n                    this.contactItemArr.push(contactItem);\r\n                    contactItem.contactBulletTime = 0;\r\n                }\r\n            }\r\n            if (this.bulletUtil && this.bulletUtil.contactBegin) {\r\n                this.bulletUtil.contactBegin(otherCollider.node);\r\n            }\r\n            let dam = this.atk;\r\n            if (this.extraObj && this.extraObj.atkPercentAdd > 0) {\r\n                dam = dam * (1 + this.extraObj.atkPercentAdd);\r\n                dam = Math.ceil(dam);\r\n            }\r\n            contactItem.hitWithDam(dam, this.getShineColor());\r\n            audioManager.playEffect(this.row.audio);\r\n        }\r\n\r\n        // 玩家子弹打敌方子弹\r\n        if (otherCollider.group == physicsGroup.MONSTER_BULLET) {\r\n            let bullet = otherCollider.getComponent(Bullet);\r\n            if (bullet.contactEnmeyCanHide()) {\r\n                bullet.recycleSelf();\r\n            }\r\n        }\r\n\r\n    }\r\n\r\n    contactEnd(selfCollider: Collider2D, otherCollider: Collider2D) {\r\n        let contactItem = null;\r\n        if (otherCollider.group == physicsGroup.MONSTER) {\r\n            contactItem = otherCollider.getComponent(Monster);\r\n        } else if (otherCollider.group == physicsGroup.PLAYER) {\r\n            contactItem = mapModel.player;\r\n        }\r\n        if (contactItem) {\r\n            let index = this.contactItemArr.indexOf(contactItem);\r\n            if (index != -1) {\r\n                this.contactItemArr.splice(index, 1);\r\n            }\r\n        }\r\n    }\r\n\r\n    getShineColor() {\r\n        if (this.bulletUtil && this.bulletUtil.shineColor) {\r\n            return this.bulletUtil.shineColor;\r\n        }\r\n    }\r\n\r\n    // 碰到敌人是否消失\r\n    contactEnmeyCanHide() {\r\n        if (this.bulletUtil && this.bulletUtil.contactNotHide) {\r\n            return false;\r\n        }\r\n        return true;\r\n    }\r\n\r\n    // 飞到屏幕外，是否可以销毁\r\n    outScreenCanRecyle() {\r\n        if (this.bulletUtil && this.bulletUtil.outScreenNotRecycle) {\r\n            return false;\r\n        }\r\n        return true;\r\n    }\r\n\r\n    recycleSelf() {\r\n        mapModel.bulletSystem.recycleBulletNode(this.node);\r\n        if (this.bulletUtil && this.bulletUtil.recycleSelfEnd) {\r\n            this.bulletUtil.recycleSelfEnd();\r\n        }\r\n        Tween.stopAllByTarget(this.node);\r\n        Tween.stopAllByTarget(this.bodyNode);\r\n        this.unscheduleAllCallbacks();\r\n        if (this.bulletUtil) {\r\n            this.bulletUtil.unscheduleAllCallbacks();\r\n        }\r\n\r\n    }\r\n\r\n    getFollowTargetPos() {\r\n        if (this.bulletUtil && this.bulletUtil.targetPos) {\r\n            return cocosUtil.vec3CopyVal(this.vec3Obj.targetPos, this.bulletUtil.targetPos);\r\n        }\r\n        // 默认跟踪玩家\r\n        return cocosUtil.vec3CopyVal(this.vec3Obj.targetPos, mapModel.player.node.position);\r\n    }\r\n\r\n    update(dt: number) {\r\n        let canMove = true;\r\n        if (this.bulletUtil && this.bulletUtil.moveStop) {\r\n            canMove = false;\r\n        }\r\n        if (this.speed <= 0) {\r\n            canMove = false;\r\n        }\r\n        if (canMove) {\r\n            let dis = this.speed * dt;\r\n            let pos = this.node.position;\r\n            if (this.isFollow) {\r\n                // 根据转速，慢慢调整角度\r\n                let targetPos = this.getFollowTargetPos();\r\n                let direction = targetPos.subtract(pos).normalize();\r\n                let radian1 = Math.atan2(direction.y, direction.x);\r\n                if (radian1 < 0) {\r\n                    radian1 += Math.PI * 2;\r\n                }\r\n                let radian2 = Math.atan2(this.direction.y, this.direction.x);\r\n                if (radian2 < 0) {\r\n                    radian2 += Math.PI * 2;\r\n                }\r\n                let dr = this.rotateSpeed * dt;\r\n                let maxDr = Math.abs(radian1 - radian2);\r\n                if (dr > maxDr) {\r\n                    dr = maxDr;\r\n                }\r\n                if (radian1 > radian2) {\r\n                    if (radian1 - radian2 > Math.PI) {\r\n                        dr = -dr;\r\n                    }\r\n                } else {\r\n                    if (radian2 - radian1 < Math.PI) {\r\n                        dr = -dr;\r\n                    }\r\n                }\r\n                this.direction = Vec3.rotateZ(this.vec3Obj.outVec3, this.direction, Vec3.ZERO, dr);\r\n                let angle = utilTools.radianToAngle(Math.atan2(this.direction.y, this.direction.x));\r\n                this.node.angle = angle;\r\n            } else {\r\n                let angle = utilTools.radianToAngle(Math.atan2(this.direction.y, this.direction.x));\r\n                this.node.angle = angle;\r\n            }\r\n\r\n            let lastDirection = null;\r\n            if (this.bulletUtil && this.bulletUtil.targetPos && this.bulletUtil.arriveTargetPos) {\r\n                // 需要判断是否到达目的地\r\n                let targetPos = this.getFollowTargetPos();\r\n                lastDirection = targetPos.subtract(pos);\r\n            }\r\n\r\n            pos.add(cocosUtil.vec3CopyVal(this.vec3Obj.direction, this.direction).multiplyScalar(dis));\r\n            this.node.position = pos;\r\n\r\n            if (lastDirection) {\r\n                let targetPos = this.getFollowTargetPos();\r\n                let afterDirection = targetPos.subtract(pos);\r\n                let afterAngle = utilTools.radianToAngle(Vec2.angle(lastDirection, afterDirection));\r\n                if (afterAngle > 90) {\r\n                    // 到达目的地\r\n                    this.bulletUtil.arriveTargetPos();\r\n                    return;\r\n                }\r\n            }\r\n        }\r\n\r\n        if (this.contactItemArr.length > 0) {\r\n            utilTools.forArr(this.contactItemArr, (contactItem: any) => {\r\n                contactItem.contactBulletTime += dt;\r\n                let timeGap = 0.5;\r\n                if (this.bulletUtil && this.bulletUtil.contactBulletTime > 0) {\r\n                    timeGap = this.bulletUtil.contactBulletTime;\r\n                }\r\n                if (contactItem.contactBulletTime >= timeGap) {\r\n                    contactItem.contactBulletTime = 0;\r\n                    contactItem.hitWithDam(this.atk, this.getShineColor());\r\n                    audioManager.playEffect(this.row.audio);\r\n                }\r\n            });\r\n        }\r\n\r\n        this.timeCount += dt;\r\n        if (this.timeCount >= 2 && this.outScreenCanRecyle() && !mapModel.isInScreenVisible(this.node)) {\r\n            this.recycleSelf();\r\n        }\r\n    }\r\n}\r\n\r\n"]}
{"version":3,"sources":["file:///G:/cocos/%E6%9C%AB%E6%97%A5%E7%89%B9%E5%B7%A5%E9%98%9F/assets/scripts/game/compoment/base/AnimationCtrl.ts"],"names":["Animation","Component","sp","_decorator","ccclass","property","AnimationCtrl","spineSkeleton","animationComponent","lastAni","lastLoop","animationEndCallback","onLoad","getComponent","Skeleton","getComponentInChildren","on","EventType","FINISHED","animationFinished","setSpineSkeletonNode","node","setAnimationNode","pauseAnimation","paused","resumeAnimation","eventName","animationState","name","playAnimation","isLoop","completeCb","loop","setAnimation","setCompleteListener","play","playAnimationOnce","endCb","Promise","resolve","reject","undefined","animation"],"mappings":"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","sourcesContent":["import { Animation, AnimationState, Component, Node, sp, _decorator } from 'cc';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('AnimationCtrl')\r\nexport class AnimationCtrl extends Component {\r\n\r\n    spineSkeleton: sp.Skeleton;\r\n    animationComponent: Animation;\r\n\r\n    lastAni: string;\r\n    lastLoop: boolean;\r\n\r\n    animationEndCallback: Function;\r\n\r\n    onLoad() {\r\n        if (!this.spineSkeleton) {\r\n            this.spineSkeleton = this.getComponent(sp.Skeleton);\r\n        }\r\n        if (!this.spineSkeleton) {\r\n            this.spineSkeleton = this.getComponentInChildren(sp.Skeleton);\r\n        }\r\n\r\n        if (!this.spineSkeleton) {\r\n            this.animationComponent = this.getComponent(Animation);\r\n        }\r\n        if (!this.animationComponent) {\r\n            this.animationComponent = this.getComponentInChildren(Animation);\r\n        }\r\n        if (this.animationComponent) {\r\n            this.animationComponent.on(Animation.EventType.FINISHED, this.animationFinished, this);\r\n        }\r\n    }\r\n\r\n    setSpineSkeletonNode(node: Node) {\r\n        this.spineSkeleton = node.getComponent(sp.Skeleton);\r\n    }\r\n    setAnimationNode(node: Node) {\r\n        this.animationComponent = node.getComponent(Animation);\r\n    }\r\n\r\n    pauseAnimation() {\r\n        if (!this.spineSkeleton) {\r\n            return;\r\n        }\r\n        this.spineSkeleton.paused = true;\r\n    }\r\n    resumeAnimation() {\r\n        if (!this.spineSkeleton) {\r\n            return;\r\n        }\r\n        this.spineSkeleton.paused = false;\r\n    }\r\n\r\n    animationFinished(eventName: string, animationState: AnimationState) {\r\n        if (eventName == Animation.EventType.FINISHED) {\r\n            if (this.animationEndCallback) {\r\n                this.animationEndCallback(animationState.name);\r\n            }\r\n        }\r\n    }\r\n\r\n    playAnimation(name: string, isLoop: boolean = true, completeCb?: Function) {\r\n        if (!name) {\r\n            return;\r\n        }\r\n\r\n        if (this.spineSkeleton) {\r\n            this.spineSkeleton.loop = isLoop;\r\n            this.spineSkeleton.setAnimation(0, name, isLoop);\r\n            if (completeCb) {\r\n                this.spineSkeleton.setCompleteListener(() => {\r\n                    // 每次循环结束都会回调\r\n                    completeCb(name);\r\n                });\r\n            } else {\r\n                // 置空回调\r\n                this.spineSkeleton.setCompleteListener(null);\r\n            }\r\n            return;\r\n        }\r\n\r\n        if (this.animationComponent) {\r\n            this.animationEndCallback = completeCb;\r\n            this.animationComponent.play(name);\r\n            return;\r\n        }\r\n\r\n    }\r\n\r\n    async playAnimationOnce(name: string, endCb?: Function) {\r\n        return new Promise((resolve, reject) => {\r\n            if (!name) {\r\n                resolve();\r\n                if (endCb) {\r\n                    endCb();\r\n                }\r\n                return;\r\n            }\r\n            if (this.spineSkeleton) {\r\n                if (this.lastAni == undefined) {\r\n                    this.lastAni = this.spineSkeleton.animation;\r\n                }\r\n                if (this.lastLoop == undefined) {\r\n                    this.lastLoop = this.spineSkeleton.loop;\r\n                }\r\n            }\r\n\r\n            this.playAnimation(name, false, () => {\r\n                if (this.spineSkeleton) {\r\n                    this.playAnimation(this.lastAni, this.lastLoop);\r\n                    this.lastAni = undefined;\r\n                    this.lastLoop = undefined;\r\n                }\r\n                resolve();\r\n                if (endCb) {\r\n                    endCb();\r\n                }\r\n            });\r\n\r\n        });\r\n    }\r\n\r\n}\r\n\r\n"]}
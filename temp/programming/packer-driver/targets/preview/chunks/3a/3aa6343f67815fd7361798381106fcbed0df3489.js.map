{"version":3,"sources":["file:///G:/cocos/%E6%9C%AB%E6%97%A5%E7%89%B9%E5%B7%A5%E9%98%9F/assets/scripts/game/compoment/sys/BulletSystem.ts"],"names":["find","Node","Prefab","UITransform","_decorator","cocosUtil","utilTools","constants","designManager","resManager","mapModel","physicsGroup","BaseLayer","NodePoolUtil","Bullet","ccclass","property","BulletSystem","idBulletLayerObj","bulletLayer","bulletLayer2","waitAddArr","onLoad","node","parent","onEnable","onDestroy","getBulletLayerNameById","id","getBulletLayerById","row","getRowById","tableName","bullet","addComponent","setPosition","prefab","nodePoolUtil","init","bulletPrefabObj","loadBulletPrefab","path","Promise","resolve","reject","loadAsset","bundles","err","addBullet","group","startWorldPos","direction","extraObj","getComponent","tmpFunc","isValid","itemNode","activeInHierarchy","push","bulletNode","getNode","addComponentOnce","forVisibleMonsterBullet","cb","forArr","children","active","isInScreenVisible","collider","MONSTER_BULLET","recycleAllBulletNodeById","name","recycleSelf","recycleBulletNode","recycleNode","updateLogic","dt","shift"],"mappings":"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","sourcesContent":["import { find, Node, Prefab, UITransform, Vec3, _decorator } from 'cc';\r\nimport { cocosUtil } from '../../../utils/cocosUtil';\r\nimport { utilTools } from '../../../utils/utilTools';\r\nimport { constants } from '../../data/constants';\r\nimport { designManager } from '../../manager/designManager';\r\nimport { resManager } from '../../manager/resManager';\r\nimport { mapModel } from '../../model/mapModel';\r\nimport { physicsGroup } from '../../other/physicsGroup';\r\nimport { BaseLayer } from '../base/BaseLayer';\r\nimport { NodePoolUtil } from '../base/NodePoolUtil';\r\nimport { Bullet } from '../item/bullet/Bullet';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('BulletSystem')\r\nexport class BulletSystem extends BaseLayer {\r\n\r\n    // 按照子弹id进行UI分层\r\n    idBulletLayerObj: any = {};\r\n\r\n    bulletLayer: Node;\r\n    bulletLayer2: Node;\r\n\r\n    waitAddArr: any = [];\r\n\r\n    onLoad() {\r\n        super.onLoad();\r\n\r\n        this.bulletLayer = this.node;\r\n        this.bulletLayer2 = find(\"bulletLayer2\", this.node.parent);\r\n    }\r\n\r\n    onEnable() {\r\n        super.onEnable();\r\n    }\r\n\r\n    onDestroy() {\r\n        super.onDestroy();\r\n    }\r\n\r\n    getBulletLayerNameById(id: number) {\r\n        return \"bulletLayer\" + id;\r\n    }\r\n\r\n    getBulletLayerById(id: number) {\r\n        let row = designManager.getRowById(constants.tableName.bullet, id);\r\n        let bulletLayer = this.idBulletLayerObj[id];\r\n        if (!bulletLayer) {\r\n            bulletLayer = new Node(this.getBulletLayerNameById(id));\r\n            bulletLayer.addComponent(UITransform);\r\n            bulletLayer.setPosition(0, 0);\r\n\r\n            switch (row.prefab) {\r\n                case \"bullet1042\": // 油桶燃烧-普通\r\n                case \"bullet1044\": // 油桶燃烧-高级\r\n                case \"bullet1071\": // 力场\r\n                case \"bullet10200\": // 泥浆\r\n                    bulletLayer.parent = this.bulletLayer2;\r\n                    break;\r\n                default:\r\n                    bulletLayer.parent = this.bulletLayer;\r\n                    break;\r\n            }\r\n\r\n            this.idBulletLayerObj[id] = bulletLayer;\r\n\r\n            let nodePoolUtil = bulletLayer.addComponent(NodePoolUtil);\r\n            nodePoolUtil.init(mapModel.bulletPrefabObj[row.prefab]);\r\n        }\r\n        return bulletLayer;\r\n    }\r\n\r\n    loadBulletPrefab(path: string) {\r\n        return new Promise((resolve, reject) => {\r\n            resManager.loadAsset(constants.bundles.bullet, path, Prefab, null, (err, prefab) => {\r\n                if (err) {\r\n                    reject();\r\n                    return;\r\n                }\r\n                resolve(prefab);\r\n            });\r\n        });\r\n    }\r\n\r\n    async addBullet(id: number, group: number, startWorldPos?: Vec3, direction?: Vec3, extraObj?: any) {\r\n        let nodePoolUtil = this.getBulletLayerById(id).getComponent(NodePoolUtil);\r\n        let row = designManager.getRowById(constants.tableName.bullet, id);\r\n        let tmpFunc = () => {\r\n            if (!cocosUtil.isValid(nodePoolUtil)) {\r\n                return;\r\n            }\r\n            if (!nodePoolUtil.itemNode) {\r\n                nodePoolUtil.init(mapModel.bulletPrefabObj[row.prefab]);\r\n            }\r\n            if (!nodePoolUtil.node.activeInHierarchy) {\r\n                let bullet: any = {};\r\n                bullet.id = id;\r\n                bullet.group = group;\r\n                bullet.startWorldPos = startWorldPos;\r\n                bullet.direction = direction;\r\n                bullet.extraObj = extraObj;\r\n                this.waitAddArr.push(bullet);\r\n                return;\r\n            }\r\n            let bulletNode = nodePoolUtil.getNode();\r\n            let bullet: Bullet = cocosUtil.addComponentOnce(bulletNode, Bullet);\r\n            bullet.init(id, group, startWorldPos, direction, extraObj);\r\n\r\n        };\r\n\r\n        if (!mapModel.bulletPrefabObj[row.prefab]) {\r\n            let prefab: any = await this.loadBulletPrefab(row.prefab);\r\n            mapModel.bulletPrefabObj[row.prefab] = prefab;\r\n        }\r\n        tmpFunc();\r\n    }\r\n\r\n    // 遍历屏幕范围内的怪物子弹\r\n    forVisibleMonsterBullet(cb: (bullet: Bullet) => void) {\r\n        utilTools.forArr(this.node.children, (bulletLayer: Node) => {\r\n            utilTools.forArr(bulletLayer.children, (bulletNode: Node) => {\r\n                if (!bulletNode.active) {\r\n                    return;\r\n                }\r\n                if (!mapModel.isInScreenVisible(bulletNode)) {\r\n                    return;\r\n                }\r\n                let bullet = bulletNode.getComponent(Bullet);\r\n                if (bullet.collider && bullet.collider.group == physicsGroup.MONSTER_BULLET) {\r\n                    cb(bullet);\r\n                }\r\n            });\r\n        });\r\n    }\r\n\r\n    recycleAllBulletNodeById(id: number) {\r\n        let name = this.getBulletLayerNameById(id);\r\n        let bulletLayer = find(name, this.bulletLayer);\r\n        if (bulletLayer) {\r\n            utilTools.forArr(bulletLayer.children, (node: Node) => {\r\n                node.getComponent(Bullet).recycleSelf();\r\n            });\r\n        }\r\n        bulletLayer = find(name, this.bulletLayer2);\r\n        if (bulletLayer) {\r\n            utilTools.forArr(bulletLayer.children, (node: Node) => {\r\n                node.getComponent(Bullet).recycleSelf();\r\n            });\r\n        }\r\n    }\r\n\r\n    recycleBulletNode(bulletNode: Node) {\r\n        let bullet = bulletNode.getComponent(Bullet);\r\n        let nodePoolUtil = this.getBulletLayerById(bullet.id).getComponent(NodePoolUtil);\r\n        nodePoolUtil.recycleNode(bulletNode);\r\n    }\r\n\r\n    updateLogic(dt: number) {\r\n        let bullet = this.waitAddArr.shift();\r\n        if (bullet) {\r\n            this.addBullet(bullet.id, bullet.group, bullet.startWorldPos, bullet.direction, bullet.extraObj);\r\n        }\r\n    }\r\n\r\n}\r\n\r\n"]}